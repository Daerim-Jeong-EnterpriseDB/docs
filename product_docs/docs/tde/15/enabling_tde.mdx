---
title: Enabling TDE
---

You enable transparent data encryption when you initialize a database cluster. (You can either use the env vars or initdb options.)

using [initdb](https://www.postgresql.org/docs/15/app-initdb.html). 

> TODO: Add example from "Key management" (and crosslink!), incorporate content from initdb.mdx

## Using environment variables

-- this content is taken from key_stores. I think we can remove it from key_stores now.

To simplify operations, the key wrap and unwrap commands can also be set in the environment variables. These are accepted by all affected applications if no corresponding command-line options have been given. 

Example:

```shell
PGDATAKEYWRAPCMD='openssl enc -e -aes128-wrap -pbkdf2 -out "%p"'
PGDATAKEYUNWRAPCMD='openssl enc -d -aes128-wrap -pbkdf2 -in "%p"'
export PGDATAKEYWRAPCMD PGDATAKEYUNWRAPCMD
```

## Using initdb options

|          Option                |                                                                                                                                                                                                                                                                  Description                                                                                                                                                                                                                                                                                                    |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| --data-encryption              | Initialize the new database cluster with transparent data encryption. See [Cryptography](tde/latest/#cryptography) for further information.                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| --copy-key-from=*file*         | Copy the data encryption key from the given location. This can be used for copying a key from an existing cluster when preparing a new cluster as a target for pg_upgrade.                                                                                                                                                                                                                                                                                                                                                                                                      |
| --key-wrap-command=*command*   | Specifies a command to wrap (encrypt) the generated data encryption key. The command should include a placeholder `%p` that specifies the file to write the wrapped key to. The unwrapped key will be provided to the command on its standard input. If this is not specified, the environment variable `PGDATAKEYWRAPCMD` is used. An empty string means to not apply any key wrapping command. Specifying this option or the environment variable fallback is required if data encryption is used. See [Key management](/tde/latest/#key-management) for further information. |
| --key-unwrap-command=*command* | Specifies a command to unwrap (decrypt) the data encryption key. The command should include a placeholder `%p` that specifies the file to read the wrapped key from. The command needs to write the unwrapped key to its standard output. If this is not specified, the environment variable `PGDATAKEYUNWRAPCMD` is used. An empty string means to not apply any key unwrapping command. Specifying this option or the environment variable fallback is required if data encryption is used. See [Key management](/tde/latest/#key-management) for further information.        |
| --no-key-wrap                  | Do not use key wrapping, thus storing the data encryption key in plaintext in the data directory. This is insecure and only suitable for testing purposes. If data encryption is selected and this option is not specified, then key wrap and unwrap commands must be provided or initdb will abort with an error. (This option is a shortcut for setting both the wrap and the unwrap command to an empty string.)                                                                                                                                                             |

## See also
[PostgreSQL initdb documentation](https://www.postgresql.org/docs/15/app-initdb.html)

## Example

Pre-requisite:
- EDB Postgres Advanced Server 15 onwards must be installed.
- Openssl must be installed.

Initialize the cluster using TDE:

Set the data encrytpion and decryption environment variables.

```shell
export PGDATAKEYWRAPCMD='openssl enc -e -aes-128-cbc -pass pass:ok -out %p'
export PGDATAKEYUNWRAPCMD='openssl enc -d -aes-128-cbc -pass pass:ok -in %p'
export LC_ALL="en_US.UTF-8"
export LC_CTYPE="en_US.UTF-8"
```

Initialize the cluster using initdb:

```shell
/usr/edb/as15/bin//initdb -D /var/lib/edb/as15/data -y
```

Start the cluster:

```shell
/usr/edb/as15/bin//pg_ctl -D /var/lib/edb/as15/data start
```
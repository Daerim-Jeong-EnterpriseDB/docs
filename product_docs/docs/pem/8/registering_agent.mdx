---
title: "Registering a PEM agent"
legacyRedirectsGenerated:
  # This list is generated by a script. If you need add entries, use the `legacyRedirects` key.
  - "/edb-docs/d/edb-postgres-enterprise-manager/user-guides/agent-user-guide/8.0/registering_agent.html"
# This file is moved from pem_agent/02_registering_agent.mdx
redirects:
- /pem/latest/pem_agent/02_registering_agent/
- /pem/latest/pem_inst_guide_linux/04_installing_postgres_enterprise_manager/09_registering_a_pem_agent/ 
---

Before a PEM agent can be used, you must register it with a PEM server. 
**PEM agents installed by the PEM server package are registered automatically during server configuration.** For all other agents you must follow the instructions below.

!!! Note
    After upgrading the PEM agent, you need to restart it. You do not need to register it again. 

## How to register PEM agents
On Linux and Windows hosts, the PEM agent package includes command line utility called 'pemworker' which you can use perform management tasks, including registering the PEM agent, as described [below](#registering-a-pem-agent-using-the-pemworker-utility).

On Windows, the PEM agent graphical installer allows you to register the agent when installing it. This is a convenience option and does not support all the options provided by pemworker. 
If you do not want the installer to register the agent, uncheck the 'register now' checkbox. For more details, refer to the [installation instructions](/pem/latest/installing/windows/).

## Registering a PEM agent using the pemworker utility
The PEM agent package installer places the pemworker utility in the `/usr/edb/pem/agent/bin` directory on Linux and `C:\Program Files\edb\pem\agent-x64`bin` on Windows. 
To register an agent, invoke the utility as shown below and add the relevant options from the table as needed. Follow each option with a corresponding value.

#### Linux

```shell
# Running as root
pemworker --register-agent
```

#### Windows

```shell
./pemworker.exe REGISTER-AGENT
```

| Option&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| ----------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `--pem-user`                        | Specifies the name of the PEM administrative user (must have the `pem_admin` role) on the PEM server to be used to write the server details to the PEM database. **Required**.                                                                                                                                                                                                                              |
| **Server parameters**               | These parameters are used to populate the connection properties in the PEM web application. They are used when a user connects from the PEM web application to the monitored server. They are also used for the persistent connection from the agent to the monitored server unless overridden by Agent Server Binding parameters (see below).                                                              |
| `--server-addr`                     | Specifies the IP address or fully qualified domain name of the monitored server. On Linux systems, you can leave the address field blank to use the default PostgreSQL Unix Domain Socket on the local machine. Or you can set it to an alternate path containing a PostgreSQL socket. If you enter a path, the path must begin with a forward slash (/). **Required**.                                     |
| `--server-port`                     | Specifies the port number of the monitored server. **Required**.                                                                                                                                                                                                                                                                                                                                            |
| `--server-database`                 | Specifies the name of the database on the monitored server to which to connect. **Required**.                                                                                                                                                                                                                                                                                                               |
| `--server-user`                     | Specifies the name of the user used to connect to the monitored server. **Required**.                                                                                                                                                                                                                                                                                                                       |
| `--server-service-name`             | Specifies the name of the operating system service that manages the monitored Postgres server. For example, a systemd service unit on Linux. Optional.                                                                                                                                                                                                                                                      |
| **Agent-server binding parameters** | These parameters are used to override the server parameters above. Use these if you wish the agent to connect to the monitored server using different credentials than those used by the PEM web application.                                                                                                                                                                                               |
| `--asb-host-name`                   | Specifies the IP address or fully qualified domain name of the monitored server. Optional, defaults to `--server-addr` if not supplied.                                                                                                                                                                                                                                                                     |
| `--asb-host-port`                   | Specifies the port number of the monitored server. Optional, defaults to `--server-port` if not supplied.                                                                                                                                                                                                                                                                                                   |
| `--asb-host-db`                     | Specifies the name of the database on the monitored server to which the agent connects. Optional, defaults to `--server-database` if not supplied.                                                                                                                                                                                                                                                          |
| `--asb-host-user`                   | Specifies the name of the user used by the agent to connect to the monitored server. Optional, defaults to `--server-user` if not supplied.                                                                                                                                                                                                                                                                 |
| `--asb-ssl-mode`                    | Specifies the type of SSL authentication to use for connections. Supported values include: `prefer`, `require`, `disable`, `verify-CA`, `verify-full`. Optional, defaults to `prefer`.                                                                                                                                                                                                                      |
| **Server metadata**                 | These parameters determine how the server is shown in the PEM web application.                                                                                                                                                                                                                                                                                                                              |
| `--group`                           | Specifies the name of the group in which the server is displayed. Optional.                                                                                                                                                                                                                                                                                                                                 |
| `--team`                            | Specifies a Postgres role on the PEM server to be assigned as the 'team' to which the monitored server belongs. Only users with this role will be able to access the server. Optional, defaults to none, meaning all users can access.                                                                                                                                                                                                                                         |
| `--owner`                           | Specifies a Postgres user on the PEM server to be assigned as the owner of the monitored server. Optional, defaults to `--pem-user`.                                                                                                                                                                                                                                                                                                                                             |
| `--display-name <name>`             | Specifies the display name of the monitored database server. Optional, defaults to the system hostname.                                                                                                                                                                                                                                                                                                     |
| **Other parameters**                |                                                                                                                                                                                                                                                                                                                                                                                                             |
| `--remote-monitoring`               | Set to `yes` if the server is not located on the same host as the agent. When remote monitoring is enabled (`yes`), agent level statistics for the monitored server aren't available for custom charts and dashboards, and the remote server isn't accessible by some PEM utilities (such as Audit Manager, Capacity Manager, Log Manager, Postgres Expert, and Tuning Wizard). Optional, defaults to `no`. |
| `--efm-cluster-name`                | Specifies the name of the EDB Failover Manager cluster that monitors the server (if applicable). Optional.                                                                                                                                                                                                                                                                                                  |
| `--efm-install-path`                | Specifies the complete path to the installation directory of EDB Failover Manager (if applicable). Optional.                                                                                                                                                                                                                                                                                                |
| `--config-dir`                      | Specifies the directory path of the agent configuration file. Optional, defaults to `<pemworker path>/../etc`.                                                                                                                                                                                                                                                                                              |

If you want to use any PEM feature for which a database server restart is required by the PEM agent (such as Audit Manager, Log Manager, or the Tuning Wizard), then you must set the value for `allow_server_restart` to `true` in the `agent.cfg` file.

!!! Note
    If you wish to run shell/batch jobs using an agent, you must specify the user for the `batch_script_user` parameter. We strongly recommend that you use a non-root user to run the scripts. 
    Using the root user might result in compromising the data security and operating system security.

Before any changes are made on the PEM database, the connecting agent is authenticated with the PEM database server. When invoking the pemworker utility, you must provide the password associated with the PEM server administrative user role (`postgres`). You can specify the administrative password in three ways:

-   Set the `PEM_MONITORED_SERVER_PASSWORD` environment variable.
-   Provide the password on the command line with the `PGPASSWORD` keyword.
-   Create an entry in the `.pgpass` file.

If you don't provide the password, a password authentication error occurs. You are prompted for any other missing required information. When the registration is complete, the server confirms that the agent was successfully registered.

## Unregistering a PEM agent
You can use the pemworker utility to unregister a PEM agent. To unregister an agent, invoking the pemworker utility as shown below.

#### Linux
``` shell
# Running as root
pemworker --unregister-agent
```

#### Windows
``` shell
./pemworker.exe UNREGISTER-AGENT
```

Append command line options to the command string when invoking the pemworker utility. Follow each option with a corresponding value:

| Option                          | Description                                                                                                                                                                                                                        |
| ------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `--pem-user <username>`         | Specifies the name of the database user (member of pem_admin role) of the PEM backend database server. This parameter is required.                                                                                               |
| `--config-dir`                  | Specifies the directory path for the configuration file. The default is `"<pemworker path>/../etc"`.                                                                                                                  |

## Advanced usage
This section describes some advanced options for PEM agent registration.

### Using a non-root user account to register a PEM agent on Linux

To use a non-root user account to register a PEM agent, you must first install the PEM agent as a root user. After installation, assume the identity of a non-root user, such as edb. Then:

1.  Log in as edb. Create `pem` and `logs` directories and assign read, write, and execute permissions:

    ```shell
    $ mkdir /home/edb/pem
    $ mkdir /home/edb/pem/logs
    $ chmod 700 /home/edb/pem
    $ chmod 700 /home/edb/pem/logs
    ```

2.  Register the agent with PEM server:

    ```shell
    $ export PEM_SERVER_PASSWORD=edb
    
    # Use the following command to create agent certificates and an agent 
    # configuration file (`agent.cfg`) in the `/home/edb/pem` directory. 
    $ /usr/edb/pem/agent/bin/pemworker --register-agent --pem-server <172.19.11.230> --pem-user postgres --pem-port 5432 --display-name non_root_pem_agent --cert-path /home/edb/pem --config-dir /home/edb/pem

    # Use the following command to assign read and write permissions to 
    # these files:
    $ chmod -R 600 /home/edb/pem/agent*
    ```

3.  Change the parameters of the `agent.cfg` file:

    ```ini
    $ vi /home/edb/pem/agent.cfg
    agent_ssl_key=/home/edb/pem/agent<id>.key
    agent_ssl_crt=/home/edb/pem/agent<id>.crt
    log_location=/home/edb/pem/worker.log
    agent_log_location=/home/edb/pem/agent.log
    ```

    Where `<id>` is the assigned PEM agent ID.

4.  Create a `tmp` directory, set the environment variable, and start the agent:
    
    ```ini
    $ mkdir /home/edb/pem/tmp
    
    # Create a script file, add the environment variable, give permissions, and execute:
    $ vi /home/edb/pem/run_pemagent.sh
    #!/bin/bash
    export TEMP=/home/edb/agent/tmp
    /usr/edb/pem/agent/bin/pemagent -c /home/edb/agent/agent.cfg
    $ chmod a+x /home/edb/pem/run_pemagent.sh
    $ cd /home/edb/pem
    $ ./run_pemagent.sh
    ```

    Your PEM agent is now registered and started with the edb user. If your machine restarts, then this agent doesn't restart automatically. You need to start it manually using the previous command.

5.  Optionally, you can create the service for this PEM agent as the root user to start this agent automatically at machine restart as follows:

    a.  Update the values for the configuration file path and the user in the `pemagent` service file as superuser:
    
       ```ini
       $ sudo vi  /usr/lib/systemd/system/pemagent.service
       [Service]
       Type=forking
       WorkingDirectory=/home/edb/pem
       Environment=LD_LIBRARY_PATH=/usr/edb/pem/agent/lib:/usr/libexec/edb-snmp++/lib 
       Environment=TEMP=/home/edb/pem/tmp
       ExecStart=/usr/edb/pem/agent/bin/pemagent -c /home/edb/pem/agent.cfg
       ```

    b.  Stop the running agent process, and then restart the agent service:
   
       ```shell
       # Find the process id of the running pem agent and pem worker process and kill that process
       $ ps -ax | grep pemagent
       $ kill -9 <process_id_of_pemagent>
       $ ps -ax | grep pemworker
       $ kill -9 <process_id_of_pemworker>
       # Enable and start pemagent service
       $ sudo systemctl enable pemagent
       $ sudo systemctl start pemagent
       $ sudo systemctl status pemagent
       ```

6.  Check the agent status on the PEM dashboard.

!!! Note
    Any probes and jobs that require root permission or access to a file owned by another user (for example,  enterprisedb) fail.

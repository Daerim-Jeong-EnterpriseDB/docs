---
title: "Upgrading a PEM installation on high-availability mode using Nginx"
---

1. Primary server: 172.17.0.2
2. Secondary server: 172.17.0.3
3. Monitored server: 172.17.0.4

# on primary (172.17.0.3)
Install EPAS-16 and PEM, configure PEM with type 1
edit postgresql.conf
    listen_addresses = '*'
    wal_level = replica
    synchronous_commit = on
    max_wal_senders = 10
    synchronous_standby_names = '*'
edit pg_hha.conf
    host    replication     repl_user       172.17.0.1/16           md5
su - enterprisedb -c "createuser --replication -P repl_user"
systemctl restart edb-as-16

# on secondary (172.17.0.4)
Install EPAS-16 and PEM, configure PEM with type 1
systemctl stop nginx
systemctl stop edb-uwsgi
systemctl stop pemagent
systemctl stop edb-as-16
rm -rf /var/lib/edb/as16/data/*
su - enterprisedb -c "pg_basebackup -R -h 172.17.0.3 -U repl_user -D /var/lib/edb/as16/data/ -P"
edit postgresql.conf (enable hot_standby)
systemctl restart edb-as-16

# check on primary 
su - enterprisedb -c "psql -U enterprisedb -p 5444 -d postgres -c \"select * from pg_stat_replication;\""

# check on secondary
su - enterprisedb -c "psql -U enterprisedb -p 5444 -d postgres -c \"select * from pg_stat_wal_receiver;\""

# copy files from primary to secondary
    /etc/edb-uwsgi/apps-available/pem.ini
    /etc/edb-uwsgi/uwsgi.ini
    /etc/systemd/system/edb-uwsgi.service
    /root/.pem/agent1.key
    /root/.pem/agent1.crt
    /usr/edb/pem/agent/etc/agent.cfg
    /usr/edb/pem/share/.install-config
    /usr/edb/pem/resources/server-pem.crt
    /usr/edb/pem/resources/server-pem.key
    /usr/edb/pem/web/pem.wsgi
    /usr/edb/pem/web/config_setup.py;

========= Swith Over =========
# on primary 
systemctl stop nginx
systemctl stop edb-uwsgi 
systemctl stop pemagent
systemctl stop edb-as-16

# on secondary 
su - enterprisedb -c "/usr/edb/as16/bin/pg_ctl promote -D /var/lib/edb/as16/data/"

# on old master
su - enterprisedb -c "touch /var/lib/edb/as16/data/standby.signal"
edit /var/lib/edb/as16/data/postgresql.auto.conf
```
primary_conninfo = 'user=repl_user password=edb channel_binding=prefer host=172.17.0.4 port=5444 sslmode=prefer sslcompression=0 sslcertmode=allow sslsni=1 ssl_min_protocol_version=TLSv1.2 gssencmode=prefer krbsrvname=postgres gssdelegation=0 target_session_attrs=any load_balance_hosts=disable'
```
systemctl restart edb-as-16

# check on new primary
su - enterprisedb -c "psql -U enterprisedb -p 5444 -d postgres -c \"select * from pg_stat_replication;\""

# check on new secondary
su - enterprisedb -c "psql -U enterprisedb -p 5444 -d postgres -c \"select * from pg_stat_wal_receiver;\"" 

# on new primary
systemctl start pemagent
systemctl start edb-uwsgi 
systemctl start nginx
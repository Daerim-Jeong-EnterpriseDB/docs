---
title: "AWS Secrets Manager integration"
---

With BigAnimal, you can use AWS Secrets Manager. AWS Secrets Manager helps you manage, retrieve, and rotate database credentials, access keys, and other secrets throughout their lifecycle.

To create a secret manager:

1. Create a PostgreSQL cluster on the BigAnimal portal.

1. Create and save an [access key](../reference/access_key/#create-your-personal-access-key).

1. Create a secret in AWS Secrets Manager for your psql credentials. 

   Create the secret manager using a Lambda script or using the AWS console:

   - Lambda script:

     ```shell
     import boto3
     import json

     def create_secret(secret_name, username, password, database, host):
                client = boto3.client('secretsmanager')

                secret_string = json.dumps({
           "username": username,
           "password": password,
           "engine": "mysql",
           "host": host,
           "dbname": database,
           "port": 3306
         })

    response = client.create_secret(
        Name=secret_name,
        SecretString=secret_string
    )

    return response
    ```
    
    Using the created secret:

    ```shell
    create_secret('mySecretName', 'myUsername', 'myPassword', 'myDatabase', 'myHost')
    ```

   - AWS console:
   
     1. Search for Secret Manager under services.
     1. Select **Store a new secret**.
     1. Select **Credentials for other databases** on **Choose secret type** page and provide:
        - Username
        - Password
        - Encryption key
        - Database
          Provide the server address, database name and port as per the selected database engine. Select **Next**.
     1. Provide **Secret name** on the **Configure secret** page. Optionally you can provide:
        - Description
        - Tags
        - Resource permissions
        - Replicate secret
        Select **Next**.
     1. Optionally, provide details on the **Configure rotation** page.
     1. Review the code in different languages like: Java, JavaScript, C#, Python3, Ruby, Go and Rust. Select **Store** to create the secret manager.

1. Create secret in centralized Secrets Manager for your Access key.

1. Create a sample login application:

   For example using Lambda script,

   ```shell
   [cloudshell-user@ip-10-130-83-78 ~]$ cat lambda_connect.py 
   import json
   import boto3
   import base64
   import psycopg2
   region = 'us-east-1'
   
   client = boto3.client('secretsmanager', region_name=region)
   response = client.get_secret_value(
               SecretId='dev/toy/demo'
                   )
   
   secretDict = json.loads(response['SecretString'])
   
   connection = psycopg2.connect(
            user=secretDict['username'], 
             password=secretDict['password'],
              host=secretDict['host'], 
                port=secretDict['port'],
                sslmode='require',
                 database=secretDict['dbname'])
   
   mycursor = connection.cursor()
   
   create = "create table Demo0503(Toyota int)"
   #sql = "INSERT into secretmgr(id,name) values (%s, %s)"
   #value = (2, "Toyota_Demo")
   mycursor.execute(create)
   
   connection.commit()
   ```

  Fetch all the rows from database:

   ```shell
   print(mycursor.rowcount, "record")
   ```

1. Create Secrets Manager rotation lambda function.

1. Manually execute Secrets Manager rotation script.

1. Manually execute your sample application.

## Example

In this example a script file has all the commands required to create Secrets Manager rotation lambda function, execute the rotation script, and execute the sample application.

```shell
cat gen_pass_rotate_bigani_and_secretmgr_pass.py 
import secrets
import string
import requests
import json
import boto3

key = "baak_1tbgf3PXdx2L7nclsMHAdGqHy9bNNAZtqgj3Y2DeYltjXkP5n"

def generate_password(length):
    alphabet = string.ascii_letters + string.digits + string.punctuation
    password = ''.join(secrets.choice(alphabet) for i in range(length))
    return password

# Generate a 12-character password
password = generate_password(12)


lambda_func = lambda: requests.patch(
    "https://portal.biganimal.com/api/v3/projects/prj_30GlIxgAyvWhtmn3/clusters/p-hxx6mp2mtw",
    data=json.dumps({"password": password}),
    headers={
        "Content-Type": "Application/JSON",
        "x-access-key": key
    }
     )

# Display the password
response = lambda_func()
print(response.status_code)
print(response.text)
print(password)

def update_password_in_secret(secret_name):
    new_password = password
    client = boto3.client('secretsmanager')
    print(new_password)
    # Get the current secret
    response = client.get_secret_value(SecretId=secret_name)
    secret_data = json.loads(response['SecretString'])

    # Update the password field
    secret_data['password'] = new_password

    # Store the updated secret
    update_response = client.update_secret(
        SecretId=secret_name,
        SecretString=json.dumps(secret_data) )

    return new_password, update_response

# Usage - Run the the password update on AWS Secret Manager
new_password, response = update_password_in_secret('/dev/toyota/demo')
```
   
---
title: "Deploying an EDB Postgres Distributed example cluster on Docker"
navTitle: "Deploying on Docker"
description: >
  A quick demonstration of deploying a PGD architecture using TPA on Docker
---


The following steps set up EDB Postgres Distributed with an Always On Single Location
architecture using local Docker containers. This platform is not suitable for production use, but can be valuable for testing the functionality and behavior of PGD clusters; you may also find it useful when familiarizing yourself with PGD commands and APIs in preparation for deployment on cloud, VM, or bare-metal platforms.

## Prerequisites

You'll need to install and configure several software packages in order to complete this example. 

### Linux environment

[TPA supports several flavors of Linux](/tpa/latest/INSTALL/) as a host platform - you should have one of them at your disposal.

!!! Important
    If you're running cgroup v2, you'll need to disable it while using TPA to deploy to Docker. 
    
    Check for cgroup v2:

    ```shell
    mount | grep cgroup | head -1
    ```

    If the output is
    ```text
    cgroup on /sys/fs/cgroup type cgroup2
    ```

    Then you'll need to disable cgroup v2:

    ```shell
    echo 'GRUB_CMDLINE_LINUX=systemd.unified_cgroup_hierarchy=false' | sudo tee \
      /etc/default/grub.d/cgroup.cfg
    sudo update-grub
    sudo reboot    
    ```

### Free disk space

You'll need at least 5GB of free storage (accessible by Docker) to deploy the cluster described by this example. A bit more is probably wise.

### Docker Engine

We'll be using Docker containers as the target platform for this PGD deployment, so you should have Docker installed and configured. We recommend using [the convenience script](https://docs.docker.com/engine/install/debian/#install-using-the-convenience-script) available at https://get.docker.com:

```shell
curl -1sLf https://get.docker.com | sudo -E bash
```

!!! Important Running as a non-root user
    Be sure to add your user to the Docker group once installed:

    ```shell
    sudo usermod -aG docker <username>
    newgrp docker
    ```

### EDB subscription

You'll need an EDB subscription in order to install TPA *and* in order to deploy PGD. 

[Sign up for a free EDB account](https://www.enterprisedb.com/accounts/register) if you don't already have one - this will give you a trial subscription to EDB's software repositories. 

Then obtain your repo token from [EDB Repos 2.0](https://www.enterprisedb.com/repos-downloads) by copying the value labeled "Repo Token" (you'll have to click "Request Access" for a token the first time you visit this page).

### Trusted Postgres Architect

We'll use the Trusted Postgres Architect (TPA) to provision and deploy PGD. You'll find instructions for installing it in the [Trusted Postgres Architect documentation](/tpa/latest/INSTALL/), which we've repeated here for convenience:

### Configure the repository

On Debian or Ubuntu: 

```shell
curl -1sLf 'https://downloads.enterprisedb.com/<your-token>/postgres_distributed/setup.deb.sh' | sudo -E bash
``` 

### Install the TPA package

```shell
sudo apt install tpaexec
```

### Configure TPA

```shell
sudo /opt/EDB/TPA/bin/tpaexec setup
export PATH=$PATH:/opt/EDB/TPA/bin
```

### Test the TPA installation

```shell
tpaexec selftest
```

## Generate a configuration file:

First, set the `EDB_SUBSCRIPTION_TOKEN` environmental variable to your EDB repo token.

```shell
export EDB_SUBSCRIPTION_TOKEN=<token>
```

Then run `tpaexec configure` to generate a configuration folder.

```shell
tpaexec configure democluster --architecture PGD-Always-ON --platform docker --epas --location-names dc1 --data-nodes-per-location 3 --no-git
```

This creates a subdirectory in the current working directory called `democluster` containing the `config.yml` configuration file TPA uses to create the cluster.

```shell
less democluster/config.yml
```

Edit the `config.yml` as needed, for example to change the IP address range used for servers or adjust locations of nodes.

We included options to specify using Docker, a single location, and three data nodes running [EDB Postgres Advanced Server](/epas/latest/). By default, PGD will also configure two [PGD Proxy](routing/proxy/) nodes and a [Barman](backup#physical-backup) node for backup. Rocky Linux is the default image for all nodes.

For simplicity in this example, we're passing the `--no-git` flag - this will prevent TPA from trying to commit configuration changes to a Git repository. 


### Provision the cluster:
   
```shell
tpaexec provision democluster
```

Since we specified Docker as the platform, TPA provisions an image, containers, networks, etc.

### Deploy the cluster: 

```shell
tpaexec deploy democluster
```

TPA installs the needed packages, applies the configuration and sets up the actual EDB Postgres Distributed cluster.

!!! Information
    If you see a failure while processing the `barman/first_backup` task, retry this step. Depending on the speed of your test machine, 40 retries may not be enough for initialization to complete in the relevant Docker containers. 
   
### Test the cluster:
   
After the successful run of the `deploy` command the cluster is ready to use. You can connect to it via `psql` or any other database client.

It's also possible to run a test that ensures the cluster is running as expected:

```shell
tpaexec test democluster
```


### Deprovisioning:

When you're done testing the cluster, you'll want to deprovision it: this will tear down the Docker containers, network, etc.

```shell
tpaexec deprovision democluster
```

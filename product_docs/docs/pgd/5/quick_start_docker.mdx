---
title: "Deploying an EDB Postgres Distributed example cluster on Docker"
navTitle: "Deploying on Docker"
description: >
  A quick demonstration of deploying a PGD architecture using TPA on Docker
---


The following steps use Trusted Postgres Architect (TPA) to set up EDB Postgres Distributed (PGD) with an Always On Single Location
architecture using local Docker containers. 

This platform is not suitable for production use, but can be valuable for testing the functionality and behavior of PGD clusters. You may also find it useful when familiarizing yourself with PGD commands and APIs in preparation for deployment on cloud, VM, or bare-metal platforms. 

!!! Note
This set of steps is specifically for Ubuntu 22.04 LTS on Intel/AMD processors.  
!!!

## Prerequisites

You'll need to install and configure several software packages in order to complete this example. 

### Linux environment

[TPA supports several flavors of Linux](/tpa/latest/INSTALL/) as a host platform. These examples are written for Ubuntu 22.04, but steps are similar for other supported platforms.

!!! Important
    If the Linux host platform you are using is running [cgroups](https://en.wikipedia.org/wiki/Cgroups) v2, you'll need to disable it and enable cgroups v1 while using TPA to deploy to Docker. 
    
    To check for cgroup v2:

    ```shell
    mount | grep cgroup | head -1
    ```

    You'll need to disable cgroup v2 if the output is:
    ```text
    cgroup on /sys/fs/cgroup type cgroup2
    ```

    To disable cgroup v2:

    ```shell
    echo 'GRUB_CMDLINE_LINUX=systemd.unified_cgroup_hierarchy=false' | sudo tee \
      /etc/default/grub.d/cgroup.cfg
    sudo update-grub
    sudo reboot    
    ```

### Free disk space

You'll need at least 5GB of free storage (accessible by Docker) to deploy the cluster described by this example. A bit more is probably wise.

### Docker Engine

We'll be using Docker containers as the target platform for this PGD deployment. If you do not have Docker installed, we recommend using [the convenience script](https://docs.docker.com/engine/install/debian/#install-using-the-convenience-script) available at https://get.docker.com:

```shell
curl -1sLf https://get.docker.com | sudo -E bash
```

!!! Important Running as a non-root user
    Be sure to add your user to the Docker group once installed:

    ```shell
    sudo usermod -aG docker <username>
    newgrp docker
    ```

### EDB account

You'll need an EDB account in order to install both TPA *and* PGD. 

[Sign up for a free EDB account](https://www.enterprisedb.com/accounts/register) if you don't already have one - this will give you a trial subscription to EDB's software repositories. 

Once you have registered, or if you are already registered, go to the [EDB Repos 2.0](https://www.enterprisedb.com/repos-downloads) page where you can obtain your "repo token". 

On your first visit to this page you'll have to select **Request Access** to generate your "repo token". Copy the token using the Copy Token icon and store it safely. 

### Trusted Postgres Architect (TPA)

We'll use TPA to provision and deploy PGD. You'll find instructions for installing it in the [Trusted Postgres Architect documentation](/tpa/latest/INSTALL/), which we've included here for convenience:

#### Configure the repository

We'll use a convenience script to configure the Postgres Distributed repository. This repository also contains the TPA packages.

On Debian or Ubuntu: 

```shell
curl -1sLf 'https://downloads.enterprisedb.com/<your-repo-token>/postgres_distributed/setup.deb.sh' | sudo -E bash
``` 

#### Install the TPA package

```shell
sudo apt install tpaexec
```

#### Configure TPA

We now need to configure TPA which configures TPA's Python environment. Just call `tpaexec` with the command `setup`.

```shell
sudo /opt/EDB/TPA/bin/tpaexec setup
export PATH=$PATH:/opt/EDB/TPA/bin
```

You can add the export command to your shell's profile.

#### Test the TPA installation

You can verify TPA is correctly installed by running `selftest`.

```shell
tpaexec selftest
```
TPA is now installed.

## Generate a configuration file

First, set the `EDB_SUBSCRIPTION_TOKEN` environmental variable to the value of your EDB repo token.

```shell
export EDB_SUBSCRIPTION_TOKEN=<your-repo-token>
```

Then run `tpaexec configure` to generate a configuration folder.

```shell
tpaexec configure democluster \
  --architecture PGD-Always-ON \
  --platform docker \
  --epas \
  --location-names dc1 \
  --data-nodes-per-location 3 \
  --no-git
```

We included options to specify using Docker, a single location, and three data nodes running [EDB Postgres Advanced Server](/epas/latest/). By default, PGD will also configure two [PGD Proxy](routing/proxy/) nodes and a [Barman](backup#physical-backup) node for backup. Rocky Linux is the default image for all nodes.

For simplicity in this example, we're passing the `--no-git` flag - this will prevent TPA from trying to commit configuration changes to a Git repository. 

This creates a subdirectory in the current working directory called `democluster` containing the `config.yml` configuration file TPA uses to create the cluster. You can view it using:

```shell
less democluster/config.yml
```

## Provision the cluster

Now we'll allocate the resources needed to run the configuration we have just created, using the `tpaexec provision` command.
   
```shell
tpaexec provision democluster
```

Since we specified Docker as the platform, TPA creates a Docker image, containers, networks, and so on.

## Deploy the cluster

With configuration in place and infrastructure provisioned, we can now deploy the distrbuted cluster.

```shell
tpaexec deploy democluster
```

TPA applies the confuration, installing the needed packages and setting up the actual EDB Postgres Distributed cluster.

!!! Tip
    If you see a failure while processing the `barman/first_backup` task, retry this step. Depending on the speed of your test machine, 40 retries may not be enough for initialization to complete in the relevant Docker containers. 
   
## Test the cluster
   
After the successful run of the `deploy` command the cluster is ready to use. 

We can now run a test that ensures the cluster is running as expected:

```shell
tpaexec test democluster
```
## Use the cluster

We can also do a quick hands-on test with psql. For convenience, we'll use the barman instance to launch psql and connect to a proxy instance. Refer back to your config.yml to identify the host name of a proxy and of the barman instance.

For example, in the following config.yml instance definitions:

```yaml
- Name: quarto
  location: dc1
  node: 5
  role:
  - pgd-proxy
  vars:
    bdr_child_group: dc1_subgroup
- Name: zebra
  location: dc1
  node: 6
  role:
  - barman
```

...the proxy instance name (and container name) is "quarto", while the barman instance is named "zebra". So we can drop into psql like so:

```shell
docker exec -it -u barman zebra psql -h quarto -p 6432 -U barman bdrdb
```

## Deprovision the cluster

When you're done testing the cluster, you'll want to deprovision it. This will tear down the Docker containers, network, and so on:

```shell
tpaexec deprovision democluster
```

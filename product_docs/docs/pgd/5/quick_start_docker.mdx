---
title: "Deploying an EDB Postgres Distributed example cluster on Docker"
navTitle: "Deploying on Docker"
description: >
  A quick demonstration of deploying a PGD architecture using TPA on Docker
---


Use Trusted Postgres Architect (TPA) to set up EDB Postgres Distributed (PGD) with an Always On, single-location architecture using local Docker containers.

## Introducing TPA and PGD

TPA makes installing and managing various Postgres configurations easy to repeat. TPA orchestrates creating and deploying Postgres. In this quick start, you install TPA first. (If TPA is already installed, you can skip those steps.) You can use TPA to deploy the cluster in this quick start and for your future deployments.

PGD is a multi-master replicating implementation of Postgres designed for high performance and availability. TPA orchestrates the PGD installation. In this quick start, TPA generates a configuration file for a PGD demonstration cluster. This cluster uses local Docker containers to host the cluster's nodes, including three replicating database nodes, two connection proxies, and one backup node. You can then use TPA to provision and deploy the required configuration and software to each node.

This configuration of PGD isn't suitable for production use but can be valuable for testing the functionality and behavior of PGD clusters. You might also find it useful when familiarizing yourself with PGD commands and APIs to prepare for deploying on cloud, VM, or bare-metal platforms. 

!!! Note
    This set of steps is specifically for Ubuntu 22.04 LTS on Intel/AMD processors.  

## Prerequisites

To complete this example, you need free storage and Docker installed. 

### Free disk space

To deploy the cluster described by this example, you need at least 5GB of free storage accessible by Docker. Surplus storage might be useful.

### Docker Engine

Docker containers are the target platform for this PGD deployment. If you don't have Docker installed, we recommend using [the convenience script](https://docs.docker.com/engine/install/debian/#install-using-the-convenience-script) available at https://get.docker.com:

```shell
curl -1sLf https://get.docker.com | sudo -E bash
```

!!! Important Running as a non-root user
    After you install Docker, be sure to add your user to the Docker group:

    ```shell
    sudo usermod -aG docker <username>
    newgrp docker
    ```

## Preparation

### EDB account

You need an EDB account to install TPA and PGD. 

[Sign up for a free EDB account](https://www.enterprisedb.com/accounts/register) if you don't already have one. Signing up gives you a trial subscription to EDB's software repositories. 

After you're registered, go to the [EDB Repos 2.0](https://www.enterprisedb.com/repos-downloads) page to get your repo token. 

On your first visit to this page, select **Request Access** to generate your repo token. Copy the token using the **Copy Token** icon, and store the token safely.

### Setting environment variables

Set the `EDB_SUBSCRIPTION_TOKEN` environment variable to the value of your EDB repo token that you got in the [EDB account](#edb-account) step:

```shell
export EDB_SUBSCRIPTION_TOKEN=<your-repo-token>
```

You can add this variable to your `.bashrc` script or similar shell profile to ensure it's always set.

### Configure the repository

All the software needed for this example is available from the Postgres Distributed package repository. Download and run a script to configure the Postgres Distributed repository. This repository also contains the TPA packages.

```shell
curl -1sLf "https://downloads.enterprisedb.com/$EDB_SUBSCRIPTION_TOKEN/postgres_distributed/setup.deb.sh" | sudo -E bash
``` 

!!! Tip "Troubleshooting repo access"
    The command above produces output starting with:
    ```text
    Executing the  setup script for the 'enterprisedb/postgres_distributed' repository ...
    ```
    If it doesn't produce output or it reports an error, double-check that you entered your token correctly. If the problem persists, [contact Support](https://support.enterprisedb.com).

## Installing Trusted Postgres Architect (TPA)

This quick start uses TPA to provision and deploy PGD. If you previously installed TPA, you can move on to the [next step](#installing-pgd-using-tpa). Full instructions for installing TPA are also in the [Trusted Postgres Architect documentation](/tpa/latest/INSTALL/).

### Linux environment

TPA supports [several distributions of Linux](/tpa/latest/INSTALL/) as a host platform. These examples are written for Ubuntu 22.04. Steps are similar for other supported platforms.

!!! Important
    If the Linux host platform you're using is running [cgroups](https://en.wikipedia.org/wiki/Cgroups) v2, disable it and enable cgroups v1 while using TPA to deploy to Docker. 
    
    To check for cgroup v2:

    ```shell
    mount | grep cgroup | head -1
    ```

    Disable cgroup v2 if the output is:
    ```text
    cgroup on /sys/fs/cgroup type cgroup2
    ```

    To disable cgroup v2:

    ```shell
    echo 'GRUB_CMDLINE_LINUX=systemd.unified_cgroup_hierarchy=false' | sudo tee \
      /etc/default/grub.d/cgroup.cfg
    sudo update-grub
    sudo reboot    
    ```


### Installing the TPA package

```shell
sudo apt install tpaexec
```

### Configuring TPA

Configure TPA, which configures TPA's Python environment. Call `tpaexec` with the command `setup`:

```shell
sudo /opt/EDB/TPA/bin/tpaexec setup
export PATH=$PATH:/opt/EDB/TPA/bin
```

You can add the export command to your shell's profile.

### Testing the TPA installation

You can verify TPA is correctly installed by running `selftest`.

```shell
tpaexec selftest
```

## Installing PGD using TPA

### Generating a configuration file

Run the [`tpaexec configure`](/tpa/latest/tpaexec-configure/) command to generate a configuration folder: 

```shell-session
tpaexec configure democluster \
  --architecture PGD-Always-ON \
  --platform docker \
  --epas \
  --location-names dc1 \
  --active-locations dc1 \
  --data-nodes-per-location 3 \
  --no-git \
  --hostnames-unsorted
```

These options specify to use Docker, a single location, and three data nodes running [EDB Postgres Advanced Server](/epas/latest/). By default, PGD also configures two [PGD proxy](routing/proxy/) nodes and a [Barman](backup#physical-backup) node for backup. Rocky Linux is the default image for all nodes.

!!! Note Deployment platforms
    Other Linux platforms are supported as deployment targets for PGD. See the [EDB Postgres Distributed compatibility table](https://www.enterprisedb.com/resources/platform-compatibility) for details.

    You don't have to deploy PGD to the same platform you're using to run TPA.

The notional location of the nodes is set to `dc1` using `--location-names`. Activate the PGD proxies in that location using `--active-locations` set to the same location.

By default, TPA commits configuration changes to a Git repository. For this example, that's not necessary, so you can pass the `--no-git` flag.

Specify for TPA to generate repeatable hostnames for the nodes by passing `--hostnames-unsorted`. 

Configuring the cluster creates a subdirectory in the current working directory called `democluster`. It contains the `config.yml` configuration file TPA uses to create the cluster. You can view it using:

```shell
less democluster/config.yml
```

!!! SeeAlso
    - View the full set of available options by running:
      ```shell
      tpaexec configure --architecture PGD-Always-ON --help
      ``` 
    - More details on PGD-Always-ON configuration options in [Deploying with TPA](tpa)
    - [`tpaexec configure`](/tpa/latest/tpaexec-configure/) in the Trusted Postgres Architect documentation
    - [AWS platform](/tpa/latest/aws/) in the Trusted Postgres Architect documentation

### Provisioning the cluster

Next, allocate the resources needed to run the configuration using the [`tpaexec provision`](/tpa/latest/tpaexec-provision/) command:
   
```shell
tpaexec provision democluster
```

Since you specified Docker as the platform, TPA creates a Docker image, containers, networks, and so on.

!!! SeeAlso
    - [`tpaexec provision`](/tpa/latest/tpaexec-provision/) in the Trusted Postgres Architect documentation

### Deploying the cluster

With configuration in place and infrastructure provisioned, you can [deploy](/tpa/latest/tpaexec-deploy/) the distributed cluster:

```shell
tpaexec deploy democluster
```

TPA applies the configuration, installing the needed packages and setting up the actual EDB Postgres Distributed cluster.

!!! Tip
    If you see a failure while processing the `barman/first_backup` task, retry this step. Depending on the speed of your test machine, 40 retries might not be enough for initialization to complete in the relevant Docker containers. 

!!! SeeAlso
    - [`tpaexec deploy`](/tpa/latest/tpaexec-deploy/) in the Trusted Postgres Architect documentation
   
### Testing the cluster
   
After you successfully run the `deploy` command, the cluster is ready to use. 

You can run a [test](/tpa/latest/tpaexec-test/) that ensures the cluster is running as expected:

```shell
tpaexec test democluster
```

## Using the cluster

You can also do a quick hands-on test with psql. You can use the barman instance to launch psql and connect to a proxy instance. As in `config.yml`, TPA assigned the name `karakul` to the barman instance and `kapok` to the first proxy.

```shell
docker exec -it -u barman karakul psql -h kapok -p 6432 -U barman bdrdb
```

## Deprovisioning the cluster

When you're done testing the cluster, deprovision it. Deprovisioning tears down the EC2 instances among other tasks.


```shell
tpaexec deprovision democluster
```

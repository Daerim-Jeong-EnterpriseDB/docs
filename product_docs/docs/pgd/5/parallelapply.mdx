---
title: Parallel apply
navTitle: Parallel apply
---

### What is Parallel apply?

!!! Note Improved in PGD 5.2
This feature has been enhanced in PGD 5.2 and is recommended for more scenarios, especially with commit scopes. 
!!!

Parallel apply is a feature of PGD that allows a PGD node to use multiple writers per subscription. This generally increases the throughput of a subscription and improves replication performance.

The transactional changes from the subscription are written by the multiple Parallel apply writers. However, each writer ensures that the final commit of its transaction does not violate the commit order as executed on the origin node. If there is a violation, an error is generated and the transaction can be rolled back. 

This mechanism has previously meant that if a transaction is pending commit and modifies a row that another transaction needs to change, and that other transaction executed on the origin node before the pending transaction did, then the resulting error could manifest itself as a deadlock if the pending transaction has taken out a lock request. 

Additionally, handling the error could increase replication lag, due to a combination of the time taken to detect the deadlock, for the client to rollback its transaction, indirect garbage collection of the already applied changes, and time taken to redo the work. 

This is where Parallel apply’s deadlock mitigation, introduced in PGD 5.2, comes into play.

Parallel apply’s deadlock mitigation is always enabled. Parallel apply deadlock mitigation gets transactions to preview their write sets before they are executed. Transactions can then probe other contemporary transactions with older commit timestamps looking for a write set intersection. 

Where there are intersections, Parallel apply executes the transaction until it finds a conflicting row. Only then will it put the transaction on hold until the intersecting transactions have committed the conflicted rows. It then continues applying row changes from the transaction.

### Configuring Parallel apply
There are two variables which control Parallel apply in PGD 5, [`bdr.max_writers_per_subscription`](/pgd/latest/reference/pgd-settings#bdrmax_writers_per_subscription) (defaults to 8) and [`bdr.writers_per_subscription`](/pgd/latest/reference/pgd-settings#bdrwriters_per_subscription) (defaults to 2).

```plain
bdr.max_writers_per_subscription = 8
bdr.writers_per_subscription = 2
```

This gives each subscription two writers, but in some circumstances, the system may allocate up to 8 writers for a subscription.

[`bdr.max_writers_per_subscription`](/pgd/latest/reference/pgd-settings#bdrmax_writers_per_subscription) can only be changed with a server restart.

[`bdr.writers_per_subscription`](/pgd/latest/reference/pgd-settings#bdrwriters_per_subscription) can be changed, for a specific subscription, without a restart by halting the subscription using [`bdr.alter_subscription_disable`](/pgd/latest/reference/nodes-management-interfaces#bdralter_subscription_disable), setting the new value and then resuming the subscription using [`bdr.alter_subscription_enable`](/pgd/latest/reference/nodes-management-interfaces#bdralter_subscription_enable). First establish the name of the subscription using `select * from bdr.subscription`. For this example, the subscription name is `bdr_bdrdb_bdrgroup_node2_node1`.


```sql
SELECT bdr.alter_subscription_disable ('bdr_bdrdb_bdrgroup_node2_node1');

UPDATE bdr.subscription
SET num_writers = 4
WHERE sub_name = 'bdr_bdrdb_bdrgroup_node2_node1';

SELECT bdr.alter_subscription_enable ('bdr_bdrdb_bdrgroup_node2_node1');
```

### When to use Parallel apply

Parallel apply is always on by default and, for most operations, we recommend that it's left on.

From PGD 5.2, Parallel apply works with CAMO. It is not compatible with Group Commit or eager replication and should be disabled if Group Commit or eager replication are in use. 

### Monitoring Parallel apply

To support Parallel apply's deadlock mitigation, PGD 5.2 adds columns to [`bdr.stat_subscription`](/pgd/latest/reference/catalogs-visible#bdrstat_subscription). The new columns are `nprovisional_waits`, `ntuple_waits` and `ncommmit_waits`. The `nprovisional_waits` value reflects the number of operations on the same tuples being performed by concurrent apply transactions. These are provisional waits which aren't actually waiting yet but could. 

If apply operations are affected by the deadlock mitigation measures, they will wait until they can be safely applied and are counted in `ntuple_waits`. Fully applied transactions which waited before being committed are counted in `ncommit_waits`. 

### Disabling Parallel apply

To disable Parallel apply set [`bdr.writers_per_subscription`](/pgd/latest/reference/pgd-settings#bdrwriters_per_subscription) to 1.




